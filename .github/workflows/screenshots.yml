name: Generate Page Screenshots

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'static/**/*.html'
      - 'static/**/*.css'
      - 'static/**/*.js'
      - 'render_pages.py'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  screenshots:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium
          # Install jq for JSON parsing (used by imgur upload)
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Generate screenshots
        run: |
          python3 render_pages.py --output-dir screenshots
      
      - name: Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: page-screenshots
          path: screenshots/*.png
          retention-days: 30
      
      - name: List generated screenshots
        id: list-screenshots
        run: |
          echo "Generated screenshots:"
          ls -lh screenshots/
          echo "screenshot_count=$(ls -1 screenshots/*.png 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
      
      - name: Upload screenshots to imgur and create comment
        id: imgur-upload
        if: github.event_name == 'pull_request'
        run: |
          # Start creating the comment
          echo "## ðŸ“¸ Page Screenshots" > comment.md
          echo "" >> comment.md
          echo "**${{ steps.list-screenshots.outputs.screenshot_count }} pages rendered**" >> comment.md
          echo "" >> comment.md
          echo "Below are the rendered screenshots of all static pages. Click to view full size." >> comment.md
          echo "" >> comment.md
          
          # Upload each screenshot to imgur and collect URLs
          if ls screenshots/*.png 1> /dev/null 2>&1; then
            for file in screenshots/*.png; do
              filename=$(basename "$file")
              pagename="${filename%.png}"
              filesize=$(du -h "$file" | cut -f1)
              
              echo "Uploading $filename to imgur..."
              
              # Upload to imgur anonymously
              # Using a public demo client ID for anonymous uploads
              # If rate limits are hit, set IMGUR_CLIENT_ID secret in repository settings
              CLIENT_ID="${{ secrets.IMGUR_CLIENT_ID }}"
              if [ -z "$CLIENT_ID" ]; then
                CLIENT_ID="546c25a59c58ad7"  # Public demo ID (rate-limited)
              fi
              
              # Upload with error handling
              response=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: Client-ID $CLIENT_ID" \
                -F "image=@$file" \
                https://api.imgur.com/3/image)
              
              # Extract HTTP status code (last line)
              http_code=$(echo "$response" | tail -n1)
              response_body=$(echo "$response" | head -n-1)
              
              # Check if upload was successful
              if [ "$http_code" = "200" ]; then
                # Extract the link from response using jq if available
                if command -v jq &> /dev/null; then
                  link=$(echo "$response_body" | jq -r '.data.link // empty' 2>/dev/null)
                else
                  # Fallback: extract link more carefully
                  link=$(echo "$response_body" | grep -o '"link":"[^"]*"' | head -n1 | cut -d'"' -f4 | sed 's/\\\//g')
                fi
              else
                echo "âš ï¸ Upload failed for $filename (HTTP $http_code)"
                link=""
              fi
              
              if [ -n "$link" ] && [[ "$link" == http* ]]; then
                echo "âœ… Uploaded $filename: $link"
                
                # Add to comment with embedded image
                echo "### $pagename ($filesize)" >> comment.md
                echo "" >> comment.md
                echo "[![$pagename]($link)]($link)" >> comment.md
                echo "" >> comment.md
                echo "<details>" >> comment.md
                echo "<summary>Click to expand full page view</summary>" >> comment.md
                echo "" >> comment.md
                echo "![$pagename]($link)" >> comment.md
                echo "" >> comment.md
                echo "</details>" >> comment.md
                echo "" >> comment.md
              else
                echo "âš ï¸ Failed to upload $filename"
                echo "### $pagename ($filesize)" >> comment.md
                echo "" >> comment.md
                echo "_Upload failed - download from artifacts below_" >> comment.md
                echo "" >> comment.md
              fi
            done
          else
            echo "- No screenshots generated (no HTML files found)" >> comment.md
          fi
          
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "" >> comment.md
          echo "**Alternative:** Download all screenshots as a ZIP file from the **Artifacts** section below." >> comment.md
          echo "" >> comment.md
          echo "*Screenshots are automatically generated on every PR that modifies HTML, CSS, or JS files.*" >> comment.md
      
      - name: Comment on PR with screenshot info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“¸ Page Screenshots')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
